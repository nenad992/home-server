<!DOCTYPE html>
<html>
  <head>
    <title>Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <style>
      body {
        background: linear-gradient(135deg, #23243a 0%, #2e8b57 100%);
        font-family: "Segoe UI", Arial, sans-serif;
        color: #f4f4f4;
        min-height: 100vh;
      }
      .navbar {
        background: rgba(41, 49, 70, 0.98);
        box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
        border-bottom: 1px solid #2e8b57;
      }
      .navbar-brand {
        font-weight: 700;
        letter-spacing: 0.5px;
        color: #fff !important;
      }
      .nav-link {
        color: #e0eafc !important;
        font-size: 1.05rem;
        transition: color 0.2s;
      }
      .nav-link:hover {
        color: #fff !important;
        text-decoration: underline;
      }
      .card {
        background: rgba(255, 255, 255, 0.13);
        border: none;
        border-radius: 18px;
        box-shadow: 0 4px 24px 0 rgba(46, 139, 87, 0.1);
        backdrop-filter: blur(7px);
        color: #23243a;
        animation: fadeInCard 0.7s cubic-bezier(0.39, 0.575, 0.565, 1) both;
        margin-bottom: 1rem;
      }
      @keyframes fadeInCard {
        0% {
          opacity: 0;
          transform: translateY(30px);
        }
        100% {
          opacity: 1;
          transform: none;
        }
      }
      .card-title {
        font-weight: 700;
        font-size: 1.2rem;
        color: #2e8b57;
        letter-spacing: 0.5px;
      }
      .grid-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 24px;
        margin-top: 24px;
      }

      /* Mobile responsive adjustments */
      @media (max-width: 768px) {
        .grid-container {
          grid-template-columns: 1fr;
          gap: 16px;
          margin-top: 16px;
        }
        .container {
          padding-left: 10px;
          padding-right: 10px;
        }
        .card {
          border-radius: 12px;
        }
        .btn-sm {
          font-size: 0.85rem;
          padding: 0.4rem 0.8rem;
        }
        .navbar-brand {
          font-size: 1.1rem;
        }
      }

      @media (max-width: 576px) {
        .grid-container {
          gap: 12px;
        }
        .card-title {
          font-size: 1.1rem;
        }
        .service-item {
          flex-direction: column;
          align-items: flex-start !important;
          gap: 0.5rem;
        }
        .service-buttons {
          display: flex;
          gap: 0.5rem;
          flex-wrap: wrap;
        }
        .service-buttons .btn {
          flex: 1;
          min-width: auto;
        }
      }

      .card.services {
        max-height: 400px;
        overflow-y: auto;
      }
      .card.status {
        grid-column: 1 / -1;
        background: rgba(255, 255, 255, 0.18);
        color: #23243a;
      }
      .btn-sm {
        font-size: 0.95rem;
        border-radius: 7px;
        transition: box-shadow 0.2s, background 0.2s;
        margin: 0.1rem;
      }
      .btn-sm:hover,
      .btn-sm:focus {
        box-shadow: 0 2px 8px 0 rgba(46, 139, 87, 0.13);
      }

      .server-offline .card:not(.status) {
        opacity: 0.6;
        pointer-events: none;
      }
      .server-offline .card.status {
        opacity: 1 !important;
      }
      .badge.bg-success,
      .badge.bg-danger {
        font-size: 1em;
        padding: 0.5em 0.8em;
        border-radius: 7px;
      }
      .icon {
        font-size: 1.2em;
        margin-right: 6px;
        vertical-align: -0.15em;
      }
      footer {
        text-align: center;
        color: #b0b0b0;
        font-size: 0.95em;
        margin-top: 40px;
        margin-bottom: 10px;
        letter-spacing: 0.5px;
      }

      .service-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
        padding: 0.5rem;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.1);
      }

      .service-name {
        min-width: 120px;
        font-weight: 500;
      }

      .status-indicator {
        min-width: 80px;
      }

      .loading {
        opacity: 0.6;
        pointer-events: none;
      }

      .text-online {
        color: #28a745 !important;
        font-weight: 600;
      }

      .text-offline {
        color: #dc3545 !important;
        font-weight: 600;
      }

      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(35, 36, 58, 0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        opacity: 1;
        transition: opacity 0.5s ease-out;
      }

      .loading-overlay.hidden {
        opacity: 0;
        pointer-events: none;
      }

      .loading-content {
        text-align: center;
        color: #f4f4f4;
      }

      .loading-spinner {
        width: 3rem;
        height: 3rem;
        border: 0.3em solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #2e8b57;
        animation: spin 1s ease-in-out infinite;
        margin: 0 auto 1rem;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .main-content {
        opacity: 0;
        animation: fadeIn 0.8s ease-in-out 0.3s forwards;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Performance optimizations */
      .card {
        will-change: transform;
        transform: translateZ(0);
      }

      /* Improved mobile performance */
      @media (max-width: 768px) {
        .grid-container {
          animation: none; /* Disable animations on mobile for better performance */
        }
        .card {
          animation-duration: 0.3s;
        }
      }
    </style>
  </head>
  <body class="{{ 'server-offline' if not online else '' }}">
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
      <div class="loading-content">
        <div class="loading-spinner"></div>
        <h5>Loading Dashboard...</h5>
        <small>Fetching server data</small>
      </div>
    </div>

    <nav class="navbar navbar-expand-lg navbar-dark px-3 sticky-top">
      <a class="navbar-brand fw-bold" href="/dashboard"
        ><i class="bi bi-hdd-network icon"></i>Home Server</a
      >
      <button
        class="navbar-toggler"
        type="button"
        data-bs-toggle="collapse"
        data-bs-target="#navbarNav"
      >
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="/apps"
              ><i class="bi bi-grid icon"></i>Apps</a
            >
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/logout" onclick="return confirmLogout()"
              ><i class="bi bi-box-arrow-right icon"></i>Logout</a
            >
          </li>
        </ul>
      </div>
    </nav>

    <div class="container py-4 main-content">
      <div class="grid-container">
        <!-- Server Status -->
        <div class="card p-3 status text-center">
          <h2 class="card-title">
            <i class="bi bi-cpu icon"></i>TrueNAS Server Status
          </h2>
          {% if online %}
          <h5>Status: <span class="text-online">ONLINE</span></h5>
          <div class="d-flex justify-content-center gap-2 mt-3 flex-wrap">
            <button class="btn btn-danger btn-sm" onclick="confirmShutdown()">
              <i class="bi bi-power icon"></i>Shutdown
            </button>
            <button class="btn btn-warning btn-sm" onclick="confirmRestart()">
              <i class="bi bi-arrow-repeat icon"></i>Restart
            </button>
          </div>
          {% else %}
          <h5>Status: <span class="text-offline">OFFLINE</span></h5>
          <div class="d-flex justify-content-center gap-2 mt-3">
            <button class="btn btn-success btn-sm" onclick="wakeUpServer()">
              <i class="bi bi-lightning icon"></i>Wake Up
            </button>
            <button class="btn btn-info btn-sm" onclick="location.reload()">
              <i class="bi bi-arrow-clockwise icon"></i>Refresh
            </button>
          </div>
          {% endif %}
        </div>

        <!-- Service Status -->
        <div class="card p-3 services">
          <h5 class="card-title">
            <i class="bi bi-gear icon"></i>Service Status
          </h5>
          {% if services and online %} {% for name, status in services.items()
          %}
          <div class="service-item">
            <span class="service-name">{{ name }}</span>
            {% if '✅' in status %}
            <span class="badge bg-success status-indicator">
              <i class="bi bi-check-circle"></i> Online
            </span>
            <div class="service-buttons">
              <button
                class="btn btn-danger btn-sm"
                onclick="serviceAction('{{ name }}', 'stop')"
              >
                <i class="bi bi-stop-circle"></i> Stop
              </button>
              <button
                class="btn btn-warning btn-sm"
                onclick="serviceAction('{{ name }}', 'restart')"
              >
                <i class="bi bi-arrow-repeat"></i> Restart
              </button>
            </div>
            {% else %}
            <span class="badge bg-danger status-indicator">
              <i class="bi bi-x-circle"></i> Offline
            </span>
            <div class="service-buttons">
              <button
                class="btn btn-success btn-sm"
                onclick="serviceAction('{{ name }}', 'start')"
              >
                <i class="bi bi-play-circle"></i> Start
              </button>
              <button
                class="btn btn-warning btn-sm"
                onclick="serviceAction('{{ name }}', 'restart')"
              >
                <i class="bi bi-arrow-repeat"></i> Restart
              </button>
            </div>
            {% endif %}
          </div>
          {% endfor %} {% else %}
          <p class="text-center">
            {% if not online %}Server offline - no service data available{% else
            %}No service data available{% endif %}
          </p>
          {% endif %}
        </div>

        <!-- Usage - Enhanced -->
        <div class="card p-3" id="usage-card">
          <h5 class="card-title">
            <i class="bi bi-bar-chart icon"></i>Usage
            <small class="text-muted" id="usage-updated"></small>
            <i
              class="bi bi-arrow-repeat text-primary d-none"
              id="usage-loading"
              style="font-size: 0.8rem"
            ></i>
          </h5>
          {% if usage and online %}
          <div class="row">
            <div class="col-md-6">
              <h6 class="text-success">Orange Pi</h6>
              <div class="mb-2">
                <div class="d-flex justify-content-between">
                  <span>CPU:</span>
                  <span class="fw-bold" id="orange-cpu"
                    >{{ usage.orange.cpu }}%</span
                  >
                </div>
                <div class="progress" style="height: 5px">
                  <div
                    class="progress-bar bg-success"
                    id="orange-cpu-bar"
                    style="width: 0%"
                  ></div>
                </div>
              </div>
              <p>
                <strong>RAM:</strong>
                <span id="orange-ram"
                  >{{ usage.orange.ram_used }} / {{ usage.orange.ram_total }}
                  MB</span
                >
              </p>
              <p>
                <strong>Temp:</strong>
                <span id="orange-temp">{{ usage.orange.temp }}°C</span>
              </p>
            </div>
            <div class="col-md-6">
              <h6 class="text-primary">TrueNAS</h6>
              <div class="mb-2">
                <div class="d-flex justify-content-between">
                  <span>CPU:</span>
                  <span class="fw-bold" id="main-cpu"
                    >{{ usage.main.cpu }}%</span
                  >
                </div>
                <div class="progress" style="height: 5px">
                  <div
                    class="progress-bar bg-primary"
                    id="main-cpu-bar"
                    style="width: 0%"
                  ></div>
                </div>
              </div>
              <p>
                <strong>RAM:</strong>
                <span id="main-ram"
                  >{{ usage.main.ram_used }} / {{ usage.main.ram_total }}
                  MB</span
                >
              </p>
              <p>
                <strong>Temp:</strong>
                <span id="main-temp">{{ usage.main.temp }}°C</span>
              </p>
            </div>
          </div>
          {% else %}
          <p id="usage-status">
            {% if not online %}Server offline - no usage data available{% else
            %}No usage data available{% endif %}
          </p>
          {% endif %}
        </div>

        <!-- Network / Traffic -->
        <div class="card p-3">
          <h5 class="card-title">
            <i class="bi bi-diagram-3 icon"></i>Network & Traffic
          </h5>
          {% if traffic and online %} {% set op_tx = traffic.orange.tx or 0 %}
          {% set op_rx = traffic.orange.rx or 0 %} {% set main_tx =
          traffic.main.tx or 0 %} {% set main_rx = traffic.main.rx or 0 %}

          <p>
            <strong>Orange Pi:</strong> ↑ {{ (op_tx / 1048576) | round(2) }} MB
            ↓ {{ (op_rx / 1048576) | round(2) }} MB
          </p>
          <p>
            <strong>TrueNAS:</strong> ↑ {{ (main_tx / 1048576) | round(2) }} MB
            ↓ {{ (main_rx / 1048576) | round(2) }} MB
          </p>
          <p>
            <strong>Total:</strong> ↑ {{ ((op_tx + main_tx) / 1048576) |
            round(2) }} MB ↓ {{ ((op_rx + main_rx) / 1048576) | round(2) }} MB
          </p>
          {% else %}
          <p>
            {% if not online %}Server offline - no traffic data available{% else
            %}No traffic data available{% endif %}
          </p>
          {% endif %}
        </div>

        <!-- Login Activity -->
        <div class="card p-3">
          <h5 class="card-title">
            <i class="bi bi-bell icon"></i>Login Activity
          </h5>
          {% if logins %}
          <div class="row">
            <div class="col-md-4">
              <h6>Today</h6>
              <p>
                <span class="text-success">
                  <i class="bi bi-check-circle"></i> {{ logins.today.success }}
                </span>
                |
                <span class="text-danger">
                  <i class="bi bi-x-circle"></i> {{ logins.today.fail }}
                </span>
              </p>
            </div>
            <div class="col-md-4">
              <h6>Yesterday</h6>
              <p>
                <span class="text-success">
                  <i class="bi bi-check-circle"></i> {{ logins.yesterday.success
                  }}
                </span>
                |
                <span class="text-danger">
                  <i class="bi bi-x-circle"></i> {{ logins.yesterday.fail }}
                </span>
              </p>
            </div>
            <div class="col-md-4">
              <h6>Last 7 Days</h6>
              <p>
                <span class="text-success">
                  <i class="bi bi-check-circle"></i> {{ logins.week.success }}
                </span>
                |
                <span class="text-danger">
                  <i class="bi bi-x-circle"></i> {{ logins.week.fail }}
                </span>
              </p>
            </div>
          </div>
          {% else %}
          <p>No login data available.</p>
          {% endif %}
        </div>

        <!-- Docker Containers - Improved -->
        <div class="card p-3" id="docker-card">
          <h5 class="card-title">
            <i class="bi bi-box-seam icon"></i>Docker Containers
            <small class="text-muted" id="docker-updated"
              >{% if docker_stats.last_updated %}{{ docker_stats.last_updated }}
              {% endif %}</small
            >
          </h5>
          {% if docker_stats and online %}
          <!-- Stats Overview with Progress Bars -->
          <div class="row mb-3">
            <div class="col-md-8">
              <div
                class="d-flex justify-content-between align-items-center mb-2"
              >
                <span
                  >Running:
                  <strong class="text-success"
                    >{{ docker_stats.running }}</strong
                  ></span
                >
                <span
                  >Stopped:
                  <strong class="text-danger"
                    >{{ docker_stats.stopped }}</strong
                  ></span
                >
                <span
                  >Total:
                  <strong class="text-info"
                    >{{ docker_stats.total }}</strong
                  ></span
                >
              </div>
              <div
                class="progress"
                style="height: 8px"
                data-total="{{ docker_stats.total if docker_stats else 0 }}"
                data-running="{{ docker_stats.running if docker_stats else 0 }}"
                data-stopped="{{ docker_stats.stopped if docker_stats else 0 }}"
              >
                <div
                  class="progress-bar bg-success"
                  id="docker-running-bar"
                  style="width: 0%"
                ></div>
                <div
                  class="progress-bar bg-danger"
                  id="docker-stopped-bar"
                  style="width: 0%"
                ></div>
              </div>
            </div>
            {% if docker_stats.avg_cpu > 0 %}
            <div class="col-md-4 text-end">
              <small class="text-muted">Avg CPU</small><br />
              <span class="h6 text-warning">{{ docker_stats.avg_cpu }}%</span>
            </div>
            {% endif %}
          </div>

          <!-- Container Grid -->
          <div
            class="row g-2"
            id="container-list"
            style="max-height: 200px; overflow-y: auto"
          >
            {% for container in docker_stats.containers %}
            <div class="col-6">
              <div
                class="p-2 border rounded {% if container.running %}border-success bg-success bg-opacity-10{% else %}border-danger bg-danger bg-opacity-10{% endif %}"
              >
                <div class="d-flex justify-content-between align-items-center">
                  <span class="fw-bold small">
                    <i
                      class="bi bi-{% if container.running %}play-circle-fill text-success{% else %}stop-circle text-danger{% endif %}"
                    ></i>
                    {{ container.name.replace('ix-', '').replace('-1',
                    '').title() }}
                  </span>
                  {% if container.running %}
                  <small class="text-success">●</small>
                  {% else %}
                  <small class="text-danger">○</small>
                  {% endif %}
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="text-center py-4">
            <i class="bi bi-box-seam text-muted" style="font-size: 2rem"></i>
            <p class="text-muted mt-2" id="docker-status">
              {% if not online %}Server offline - no Docker data available{%
              else %}No Docker data available{% endif %}
            </p>
          </div>
          {% endif %}
        </div>

        <!-- System Information - New Card -->
        <div class="card p-3" id="system-card">
          <h5 class="card-title">
            <i class="bi bi-pc-display icon"></i>System Info
            <small class="text-muted" id="system-updated"
              >{% if system_info.last_updated %}{{ system_info.last_updated }}
              {% endif %}</small
            >
          </h5>
          {% if system_info and online %}

          <!-- Uptime -->
          {% if system_info.uptime != 'N/A' %}
          <p>
            <strong>Uptime:</strong>
            <span id="system-uptime">{{ system_info.uptime }}</span>
          </p>
          {% endif %}

          <!-- CPU Info -->
          {% if system_info.cpu %}
          <div class="mb-2">
            <h6 class="text-info mb-1">CPU</h6>
            <div id="cpu-info">
              {% if system_info.cpu.model %}
              <small><strong>Model:</strong> {{ system_info.cpu.model }}</small
              ><br />
              {% endif %} {% if system_info.cpu.count %}
              <small><strong>CPUs:</strong> {{ system_info.cpu.count }}</small>
              {% endif %} {% if system_info.cpu.cores %} |
              <small><strong>Cores:</strong> {{ system_info.cpu.cores }}</small>
              {% endif %}
            </div>
          </div>
          {% endif %}

          <!-- Memory Info -->
          {% if system_info.memory %}
          <div class="mb-2">
            <h6 class="text-warning mb-1">Memory</h6>
            <div id="memory-info">
              <small
                ><strong>Total:</strong> {{ system_info.memory.total }}</small
              >
              |
              <small
                ><strong>Used:</strong> {{ system_info.memory.used }}</small
              >
              |
              <small
                ><strong>Available:</strong> {{ system_info.memory.available
                }}</small
              >
            </div>
          </div>
          {% endif %} {% else %}
          <p id="system-status">
            {% if not online %}Server offline - no system data available{% else
            %}No system data available{% endif %}
          </p>
          {% endif %}
        </div>

        <!-- Network Information - Improved -->
        <div class="card p-3" id="network-card">
          <h5 class="card-title">
            <i class="bi bi-router icon"></i>Network Overview
            <small class="text-muted" id="network-updated">
              {% if network.last_updated %}{{ network.last_updated }}{% endif %}
            </small>
          </h5>
          {% if network and online %}

          <!-- Gateway Info -->
          {% if network.default_gateway != 'N/A' %}
          <div class="alert alert-info py-2 mb-3">
            <i class="bi bi-router-fill me-2"></i>
            <strong>Gateway:</strong>
            <span id="network-gateway">{{ network.default_gateway }}</span>
          </div>
          {% endif %}

          <!-- Network Interfaces - Grouped -->
          {% if network.interfaces %}
          <div class="row g-2" id="interface-list">
            {% set active_interfaces = [] %} {% set inactive_interfaces = [] %}
            {% for interface in network.interfaces %} {% if interface.state ==
            'UP' %} {% set _ = active_interfaces.append(interface) %} {% else %}
            {% set _ = inactive_interfaces.append(interface) %} {% endif %} {%
            endfor %}

            <!-- Active Interfaces -->
            {% if active_interfaces %}
            <div class="col-12">
              <h6 class="text-success mb-2">
                <i class="bi bi-check-circle-fill me-1"></i>
                Active Interfaces ({{ active_interfaces|length }})
              </h6>
              {% for interface in active_interfaces %}
              <div
                class="card border-success mb-2"
                style="background-color: rgba(25, 135, 84, 0.1)"
              >
                <div class="card-body py-2">
                  <div
                    class="d-flex justify-content-between align-items-center"
                  >
                    <div>
                      <strong class="text-success">{{ interface.name }}</strong>
                      {% if interface.addresses %}
                      <br /><small class="text-muted"
                        >{{ interface.addresses[0] if interface.addresses else
                        'No IP' }}</small
                      >
                      {% endif %}
                    </div>
                    <span class="badge bg-success">
                      <i class="bi bi-wifi me-1"></i>{{ interface.state }}
                    </span>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
            {% endif %}

            <!-- Inactive Interfaces -->
            {% if inactive_interfaces %}
            <div class="col-12">
              <h6 class="text-secondary mb-2">
                <i class="bi bi-x-circle me-1"></i>
                Inactive Interfaces ({{ inactive_interfaces|length }})
              </h6>
              {% for interface in inactive_interfaces %}
              <div
                class="card border-secondary mb-2"
                style="background-color: rgba(108, 117, 125, 0.1)"
              >
                <div class="card-body py-2">
                  <div
                    class="d-flex justify-content-between align-items-center"
                  >
                    <div>
                      <strong class="text-secondary"
                        >{{ interface.name }}</strong
                      >
                      <br /><small class="text-muted">Disconnected</small>
                    </div>
                    <span class="badge bg-secondary">
                      <i class="bi bi-wifi-off me-1"></i>{{ interface.state }}
                    </span>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
            {% endif %}
          </div>
          {% endif %} {% else %}
          <div class="text-center py-4">
            <i class="bi bi-router text-muted" style="font-size: 2rem"></i>
            <p class="text-muted mt-2" id="network-status">
              {% if not online %}Server offline - no network data available{%
              else %}No network data available{% endif %}
            </p>
          </div>
          {% endif %}
        </div>

        <!-- System Alerts - New Card -->
        <div class="card p-3" id="alerts-card">
          <h5 class="card-title">
            <i class="bi bi-exclamation-triangle icon"></i>System Alerts
            <span
              class="badge {% if alerts.count > 0 %}bg-warning{% else %}bg-success{% endif %} ms-2"
              id="alerts-count"
            >
              {{ alerts.count if alerts.count > 0 else '0' }}
            </span>
            <small class="text-muted" id="alerts-updated">
              {% if alerts.last_updated %}{{ alerts.last_updated }}{% endif %}
            </small>
          </h5>
          {% if alerts and alerts.alerts and online %}
          <div id="alerts-list" style="max-height: 200px; overflow-y: auto">
            {% for alert in alerts.alerts %}
            <div class="alert alert-{{ alert.type }} py-2 mb-2">
              <i class="bi bi-{{ alert.icon }} me-2"></i>{{ alert.message }}
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="alert alert-success py-2 mb-0" id="no-alerts">
            <i class="bi bi-check-circle me-2"></i>{% if not online %}Server
            offline - no alerts available{% else %}All systems normal{% endif %}
          </div>
          {% endif %}
        </div>

        <!-- Quick Actions - New Card -->
        <div class="card p-3" id="quick-actions-card">
          <h5 class="card-title">
            <i class="bi bi-lightning icon"></i>Quick Actions
          </h5>
          {% if online %}
          <div class="row g-2">
            <div class="col-6">
              <button
                class="btn btn-outline-primary btn-sm w-100"
                onclick="executeQuickAction('docker-prune')"
              >
                <i class="bi bi-trash3"></i> Clean Docker
              </button>
            </div>
            <div class="col-6">
              <button
                class="btn btn-outline-info btn-sm w-100"
                onclick="executeQuickAction('container-health')"
              >
                <i class="bi bi-heart-pulse"></i> Health Check
              </button>
            </div>
            <div class="col-6">
              <button
                class="btn btn-outline-warning btn-sm w-100"
                onclick="executeQuickAction('check-disk')"
              >
                <i class="bi bi-hdd"></i> Check Disk
              </button>
            </div>
            <div class="col-6">
              <button
                class="btn btn-outline-secondary btn-sm w-100"
                onclick="executeQuickAction('update-packages')"
              >
                <i class="bi bi-arrow-repeat"></i> Check Updates
              </button>
            </div>
          </div>
          {% else %}
          <p class="text-muted mb-0">Server offline - actions unavailable</p>
          {% endif %}
        </div>

        <!-- Security Monitor - New Card -->
        <div class="card p-3" id="security-card">
          <h5 class="card-title">
            <i class="bi bi-shield-check icon"></i>Security Monitor
            <small class="text-muted" id="security-updated">
              {% if security.last_updated %}{{ security.last_updated }}{% endif
              %}
            </small>
          </h5>
          {% if security and online %}
          <div class="row text-center mb-3">
            <div class="col-6">
              <div
                class="h5 {% if security.failed_logins > 0 %}text-danger{% else %}text-success{% endif %} mb-0"
                id="failed-logins"
              >
                {{ security.failed_logins }}
              </div>
              <small class="text-muted">Failed Logins (1h)</small>
            </div>
            <div class="col-6">
              <div class="h5 text-info mb-0" id="active-connections">
                {{ security.active_connections }}
              </div>
              <small class="text-muted">Active SSH</small>
            </div>
          </div>
          {% if security.ssh_attempts %}
          <h6 class="text-warning mb-2">Recent Attempts</h6>
          <div id="ssh-attempts" style="max-height: 100px; overflow-y: auto">
            {% for attempt in security.ssh_attempts[-5:] %}
            <div
              class="d-flex justify-content-between py-1 px-2 mb-1 bg-light rounded"
            >
              <small class="text-danger">{{ attempt.ip }}</small>
              <small class="text-muted">{{ attempt.time }}</small>
            </div>
            {% endfor %}
          </div>
          {% endif %} {% else %}
          <p id="security-status">
            {% if not online %}Server offline - no security data available{%
            else %}No security data available{% endif %}
          </p>
          {% endif %}
        </div>

        <!-- Enhanced Network Bandwidth -->
        <div class="card p-3" id="bandwidth-card">
          <h5 class="card-title">
            <i class="bi bi-speedometer2 icon"></i>Network Bandwidth
            <small class="text-muted" id="bandwidth-updated">
              {% if bandwidth.last_updated %}{{ bandwidth.last_updated }}{%
              endif %}
            </small>
          </h5>
          {% if bandwidth and online %}

          <!-- Total Bandwidth Overview -->
          <div class="row mb-4">
            <div class="col-md-6">
              <div class="card border-success h-100">
                <div class="card-body text-center py-3">
                  <i
                    class="bi bi-download text-success"
                    style="font-size: 1.5rem"
                  ></i>
                  <div class="h4 text-success mb-1" id="total-rx">
                    {{ bandwidth.total_rx }} MB
                  </div>
                  <small class="text-muted">Total Downloaded</small>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card border-primary h-100">
                <div class="card-body text-center py-3">
                  <i
                    class="bi bi-upload text-primary"
                    style="font-size: 1.5rem"
                  ></i>
                  <div class="h4 text-primary mb-1" id="total-tx">
                    {{ bandwidth.total_tx }} MB
                  </div>
                  <small class="text-muted">Total Uploaded</small>
                </div>
              </div>
            </div>
          </div>

          <!-- Interface Performance -->
          {% if bandwidth.interfaces %}
          <h6 class="text-info mb-3">
            <i class="bi bi-graph-up me-1"></i>Interface Performance
          </h6>
          <div
            id="bandwidth-interfaces"
            class="row g-2"
            style="max-height: 200px; overflow-y: auto"
          >
            {% for name, iface in bandwidth.interfaces.items() %}
            <div class="col-12">
              <div class="card border-light">
                <div class="card-body py-2">
                  <div
                    class="d-flex justify-content-between align-items-center mb-2"
                  >
                    <strong class="text-info">{{ name }}</strong>
                    {% if iface.rx_errors > 0 or iface.tx_errors > 0 %}
                    <span class="badge bg-warning">
                      <i class="bi bi-exclamation-triangle me-1"></i>{{
                      iface.rx_errors + iface.tx_errors }} Errors
                    </span>
                    {% else %}
                    <span class="badge bg-success">
                      <i class="bi bi-check-circle me-1"></i>Healthy
                    </span>
                    {% endif %}
                  </div>
                  <div class="row text-center">
                    <div class="col-6">
                      <div class="border-end">
                        <div class="text-success">{{ iface.rx_mb }} MB</div>
                        <small class="text-muted">↓ Downloaded</small>
                      </div>
                    </div>
                    <div class="col-6">
                      <div class="text-primary">{{ iface.tx_mb }} MB</div>
                      <small class="text-muted">↑ Uploaded</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          {% endif %} {% else %}
          <div class="text-center py-4">
            <i
              class="bi bi-speedometer2 text-muted"
              style="font-size: 2rem"
            ></i>
            <p class="text-muted mt-2" id="bandwidth-status">
              {% if not online %}Server offline - no bandwidth data available{%
              else %}No bandwidth data available{% endif %}
            </p>
          </div>
          {% endif %}
        </div>

        <!-- Container Logs Viewer - New Card -->
        <div class="card p-3" id="logs-card">
          <h5 class="card-title">
            <i class="bi bi-journal-text icon"></i>Container Logs
          </h5>
          {% if docker_stats and docker_stats.containers and online %}
          <div class="mb-3">
            <select
              class="form-select form-select-sm"
              id="container-select"
              onchange="loadContainerLogs()"
            >
              <option value="">Select container...</option>
              {% for container in docker_stats.containers %}
              <option value="{{ container.name }}">
                {{ container.name.replace('ix-', '').replace('-1', '') }}
              </option>
              {% endfor %}
            </select>
          </div>
          <div
            id="logs-content"
            style="
              max-height: 200px;
              overflow-y: auto;
              background: #f8f9fa;
              padding: 10px;
              border-radius: 5px;
              font-family: monospace;
              font-size: 0.85rem;
            "
          >
            <div class="text-muted">Select a container to view logs...</div>
          </div>
          {% else %}
          <p class="text-muted mb-0">
            {% if not online %}Server offline - logs unavailable{% else %}No
            containers available{% endif %}
          </p>
          {% endif %}
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      function confirmLogout() {
        return confirm("Are you sure you want to logout?");
      }

      function confirmShutdown() {
        Swal.fire({
          title: "Are you sure?",
          text: "This will shut down the TrueNAS server!",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#d33",
          cancelButtonColor: "#3085d6",
          confirmButtonText: "Yes, shut it down",
          reverseButtons: true,
        }).then((result) => {
          if (result.isConfirmed) {
            fetch("/shutdown", { method: "POST" })
              .then((response) => response.json())
              .then((data) => {
                if (data.success) {
                  Swal.fire(
                    "Shutdown Initiated",
                    "The server shutdown command has been sent.",
                    "success"
                  );
                  setTimeout(() => location.reload(), 3000);
                } else {
                  Swal.fire(
                    "Error",
                    data.error || "Failed to shutdown server",
                    "error"
                  );
                }
              })
              .catch((error) => {
                Swal.fire("Error", "Failed to send shutdown command", "error");
              });
          }
        });
      }

      function confirmRestart() {
        Swal.fire({
          title: "Are you sure?",
          text: "This will restart the TrueNAS server!",
          icon: "question",
          showCancelButton: true,
          confirmButtonColor: "#f0ad4e",
          cancelButtonColor: "#3085d6",
          confirmButtonText: "Yes, restart it",
          reverseButtons: true,
        }).then((result) => {
          if (result.isConfirmed) {
            fetch("/restart", { method: "POST" })
              .then((response) => response.json())
              .then((data) => {
                if (data.success) {
                  Swal.fire(
                    "Restart Initiated",
                    "The server restart command has been sent.",
                    "success"
                  );
                  setTimeout(() => location.reload(), 3000);
                } else {
                  Swal.fire(
                    "Error",
                    data.error || "Failed to restart server",
                    "error"
                  );
                }
              })
              .catch((error) => {
                Swal.fire("Error", "Failed to send restart command", "error");
              });
          }
        });
      }

      function wakeUpServer() {
        Swal.fire({
          title: "Wake Up Server",
          text: "Sending Wake-on-LAN packet to TrueNAS server...",
          icon: "info",
          showCancelButton: true,
          confirmButtonColor: "#28a745",
          confirmButtonText: "Send Wake-up Signal",
        }).then((result) => {
          if (result.isConfirmed) {
            fetch("/wakeup", { method: "POST" })
              .then((response) => response.json())
              .then((data) => {
                if (data.success) {
                  Swal.fire(
                    "Wake-up Signal Sent",
                    "Please wait a moment for the server to start up.",
                    "success"
                  );
                  setTimeout(() => location.reload(), 10000);
                } else {
                  Swal.fire(
                    "Error",
                    data.error || "Failed to send wake-up signal",
                    "error"
                  );
                }
              })
              .catch((error) => {
                Swal.fire("Error", "Failed to send wake-up signal", "error");
              });
          }
        });
      }

      function serviceAction(service, action) {
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="bi bi-hourglass-split"></i> Working...';
        button.disabled = true;

        fetch(`/service/${service}/${action}`, {
          method: "POST",
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              Swal.fire("Success", data.message, "success");
              setTimeout(() => location.reload(), 2000);
            } else {
              Swal.fire(
                "Error",
                data.error || `Failed to ${action} ${service}`,
                "error"
              );
              button.innerHTML = originalText;
              button.disabled = false;
            }
          })
          .catch((error) => {
            Swal.fire("Error", `Failed to ${action} ${service}`, "error");
            button.innerHTML = originalText;
            button.disabled = false;
          });
      }

      // Real-time data updates every 2 minutes (improved performance with caching)
      let updateInterval;
      let countdownInterval;
      let nextUpdateTime = 2 * 60; // 2 minutes in seconds

      function updateDashboardData() {
        fetch("/api/dashboard-data")
          .then((response) => response.json())
          .then((data) => {
            if (data.error) {
              console.error("Failed to fetch data:", data.error);
              return;
            }

            updateDashboardCards(data);
            nextUpdateTime = 2 * 60; // Reset countdown
            console.log("Dashboard data updated at", data.timestamp);
          })
          .catch((error) => {
            console.error("Error fetching dashboard data:", error);
          });
      }

      function updateDashboardCards(data) {
        // Update timestamps
        if (data.docker_stats && data.docker_stats.last_updated) {
          document.getElementById("docker-updated").textContent =
            data.docker_stats.last_updated;
        }
        if (data.network && data.network.last_updated) {
          document.getElementById("network-updated").textContent =
            data.network.last_updated;
        }
        if (data.system_info && data.system_info.last_updated) {
          document.getElementById("system-updated").textContent =
            data.system_info.last_updated;
        }

        // Update Docker stats
        if (data.docker_stats) {
          const dockerTotal = document.getElementById("docker-total");
          const dockerRunning = document.getElementById("docker-running");
          const dockerStopped = document.getElementById("docker-stopped");
          const dockerCpu = document.getElementById("docker-cpu");

          if (dockerTotal) dockerTotal.textContent = data.docker_stats.total;
          if (dockerRunning)
            dockerRunning.textContent = data.docker_stats.running;
          if (dockerStopped)
            dockerStopped.textContent = data.docker_stats.stopped;
          if (dockerCpu && data.docker_stats.avg_cpu > 0) {
            dockerCpu.textContent = data.docker_stats.avg_cpu + "%";
          }

          // Update Docker progress bars
          const dockerRunningBar =
            document.getElementById("docker-running-bar");
          const dockerStoppedBar =
            document.getElementById("docker-stopped-bar");
          if (
            dockerRunningBar &&
            dockerStoppedBar &&
            data.docker_stats.total > 0
          ) {
            const runningPct =
              (data.docker_stats.running * 100) / data.docker_stats.total;
            const stoppedPct =
              (data.docker_stats.stopped * 100) / data.docker_stats.total;
            dockerRunningBar.style.width = runningPct + "%";
            dockerStoppedBar.style.width = stoppedPct + "%";
          }

          // Update container list
          const containerList = document.getElementById("container-list");
          if (containerList && data.docker_stats.containers) {
            let html = "";
            data.docker_stats.containers.forEach((container) => {
              const badgeClass = container.running ? "bg-success" : "bg-danger";
              const icon = container.running ? "●" : "○";
              const displayName = container.name
                .replace("ix-", "")
                .replace("-1", "");

              html += `
                <div class="d-flex justify-content-between align-items-center py-1 px-2 mb-1 bg-light rounded">
                  <small class="fw-bold">${displayName}</small>
                  <span class="badge ${badgeClass}">${icon}</span>
                </div>
              `;
            });
            containerList.innerHTML = html;
          }
        }

        // Update system info
        if (data.system_info) {
          const systemUptime = document.getElementById("system-uptime");
          if (systemUptime && data.system_info.uptime) {
            systemUptime.textContent = data.system_info.uptime;
          }

          const memoryInfo = document.getElementById("memory-info");
          if (memoryInfo && data.system_info.memory) {
            const mem = data.system_info.memory;
            memoryInfo.innerHTML = `
              <small><strong>Total:</strong> ${mem.total}</small> |
              <small><strong>Used:</strong> ${mem.used}</small> |
              <small><strong>Available:</strong> ${mem.available}</small>
            `;
          }
        }

        // Update network info
        if (data.network) {
          const networkGateway = document.getElementById("network-gateway");
          if (networkGateway && data.network.default_gateway) {
            networkGateway.textContent = data.network.default_gateway;
          }

          // Network interfaces are now handled by the improved template
          // No need to manually update since we have better server-side grouping
        }

        // Update usage data
        if (data.usage) {
          // Orange Pi usage
          if (data.usage.orange) {
            const orangeCpu = document.getElementById("orange-cpu");
            const orangeRam = document.getElementById("orange-ram");
            const orangeTemp = document.getElementById("orange-temp");

            if (orangeCpu) {
              orangeCpu.textContent = data.usage.orange.cpu + "%";
              // Update progress bar
              const progressBar = orangeCpu
                .closest(".col-md-6")
                .querySelector(".progress-bar");
              if (progressBar) {
                progressBar.style.width = data.usage.orange.cpu + "%";
              }
            }
            if (orangeRam) {
              orangeRam.textContent = `${data.usage.orange.ram_used} / ${data.usage.orange.ram_total} MB`;
            }
            if (orangeTemp) {
              orangeTemp.textContent = data.usage.orange.temp + "°C";
            }
          }

          // TrueNAS usage
          if (data.usage.main) {
            const mainCpu = document.getElementById("main-cpu");
            const mainRam = document.getElementById("main-ram");
            const mainTemp = document.getElementById("main-temp");

            if (mainCpu) {
              mainCpu.textContent = data.usage.main.cpu + "%";
              // Update progress bar
              const progressBar = mainCpu
                .closest(".col-md-6")
                .querySelector(".progress-bar");
              if (progressBar) {
                progressBar.style.width = data.usage.main.cpu + "%";
              }
            }
            if (mainRam) {
              mainRam.textContent = `${data.usage.main.ram_used} / ${data.usage.main.ram_total} MB`;
            }
            if (mainTemp) {
              mainTemp.textContent = data.usage.main.temp + "°C";
            }
          }
        }

        // Update alerts
        if (data.alerts) {
          const alertsCount = document.getElementById("alerts-count");
          const alertsList = document.getElementById("alerts-list");
          const noAlerts = document.getElementById("no-alerts");

          if (alertsCount) {
            alertsCount.textContent = data.alerts.count;
            alertsCount.className = `badge ms-2 ${
              data.alerts.count > 0 ? "bg-warning" : "bg-success"
            }`;
          }

          if (data.alerts.alerts && data.alerts.alerts.length > 0) {
            let alertsHtml = "";
            data.alerts.alerts.forEach((alert) => {
              alertsHtml += `
                <div class="alert alert-${alert.type} py-2 mb-2">
                  <i class="bi bi-${alert.icon} me-2"></i>${alert.message}
                </div>
              `;
            });
            if (alertsList) alertsList.innerHTML = alertsHtml;
            if (noAlerts) noAlerts.style.display = "none";
          } else {
            if (alertsList) alertsList.innerHTML = "";
            if (noAlerts) {
              noAlerts.innerHTML =
                '<i class="bi bi-check-circle me-2"></i>All systems normal';
              noAlerts.style.display = "block";
            }
          }
        }

        // Update security info
        if (data.security) {
          const failedLogins = document.getElementById("failed-logins");
          const activeConnections =
            document.getElementById("active-connections");

          if (failedLogins) {
            failedLogins.textContent = data.security.failed_logins;
            failedLogins.className = `h5 mb-0 ${
              data.security.failed_logins > 0 ? "text-danger" : "text-success"
            }`;
          }
          if (activeConnections) {
            activeConnections.textContent = data.security.active_connections;
          }
        }

        // Update bandwidth info
        if (data.bandwidth) {
          const totalRx = document.getElementById("total-rx");
          const totalTx = document.getElementById("total-tx");

          if (totalRx) totalRx.textContent = data.bandwidth.total_rx + " MB";
          if (totalTx) totalTx.textContent = data.bandwidth.total_tx + " MB";
        }

        // Show update indicator briefly
        const loadingIndicator = document.getElementById("usage-loading");
        if (loadingIndicator) {
          loadingIndicator.classList.remove("d-none");
          setTimeout(() => {
            loadingIndicator.classList.add("d-none");
          }, 2000);
        }
      }

      function startUpdateTimer() {
        // Update every 2 minutes (improved with caching)
        updateInterval = setInterval(updateDashboardData, 2 * 60 * 1000);

        // Countdown timer (optional visual feedback)
        countdownInterval = setInterval(() => {
          nextUpdateTime--;
          if (nextUpdateTime <= 0) {
            nextUpdateTime = 2 * 60;
          }
        }, 1000);
      }

      // Initialize progress bars on page load
      function initializeProgressBars() {
        // Initialize Orange Pi CPU bar
        const orangeBar = document.getElementById("orange-cpu-bar");
        if (orangeBar) {
          orangeBar.style.width =
            "{{ usage.orange.cpu if usage and usage.orange else 0 }}%";
        }

        // Initialize TrueNAS CPU bar
        const mainBar = document.getElementById("main-cpu-bar");
        if (mainBar) {
          mainBar.style.width =
            "{{ usage.main.cpu if usage and usage.main else 0 }}%";
        }

        // Initialize Docker progress bars from data attributes
        const dockerRunningBar = document.getElementById("docker-running-bar");
        const dockerStoppedBar = document.getElementById("docker-stopped-bar");
        if (dockerRunningBar && dockerStoppedBar) {
          const progressContainer = dockerRunningBar.parentElement;
          const dockerTotal = parseInt(progressContainer.dataset.total);
          const dockerRunning = parseInt(progressContainer.dataset.running);
          const dockerStopped = parseInt(progressContainer.dataset.stopped);

          if (dockerTotal > 0) {
            const runningPct = (dockerRunning * 100) / dockerTotal;
            const stoppedPct = (dockerStopped * 100) / dockerTotal;
            dockerRunningBar.style.width = runningPct + "%";
            dockerStoppedBar.style.width = stoppedPct + "%";
          }
        }
      }

      // Hide loading overlay when page is fully loaded
      window.addEventListener("load", function () {
        setTimeout(() => {
          const loadingOverlay = document.getElementById("loading-overlay");
          if (loadingOverlay) {
            loadingOverlay.classList.add("hidden");
            // Remove the overlay completely after transition
            setTimeout(() => {
              loadingOverlay.remove();
            }, 500);
          }
        }, 800);
      });

      // Initial data fetch and start timer
      document.addEventListener("DOMContentLoaded", function () {
        // Initialize progress bars with server data
        initializeProgressBars();

        // Start the update timer
        startUpdateTimer();

        // Perform initial update after 30 seconds to refresh any stale data
        setTimeout(updateDashboardData, 30000);
      });

      // Quick Actions functionality
      function executeQuickAction(action) {
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="bi bi-hourglass-split"></i> Working...';
        button.disabled = true;

        fetch("/api/quick-action", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ action: action }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              Swal.fire({
                title: "Action Completed",
                html: `<pre style="text-align: left; font-size: 0.85rem; max-height: 300px; overflow-y: auto;">${data.output}</pre>`,
                icon: "success",
                confirmButtonText: "OK",
              });
            } else {
              Swal.fire("Error", data.error || "Action failed", "error");
            }
            button.innerHTML = originalText;
            button.disabled = false;
          })
          .catch((error) => {
            Swal.fire("Error", "Failed to execute action", "error");
            button.innerHTML = originalText;
            button.disabled = false;
          });
      }

      // Container Logs functionality
      function loadContainerLogs() {
        const containerSelect = document.getElementById("container-select");
        const logsContent = document.getElementById("logs-content");
        const containerName = containerSelect.value;

        if (!containerName) {
          logsContent.innerHTML =
            '<div class="text-muted">Select a container to view logs...</div>';
          return;
        }

        logsContent.innerHTML =
          '<div class="text-info"><i class="bi bi-hourglass-split"></i> Loading logs...</div>';

        fetch(`/api/container-logs/${containerName}?lines=100`)
          .then((response) => response.json())
          .then((data) => {
            if (data.logs && data.logs.length > 0) {
              let logsHtml = "";
              data.logs.forEach((log) => {
                logsHtml += `<div style="margin-bottom: 2px; word-wrap: break-word;">${log.line}</div>`;
              });
              logsContent.innerHTML = logsHtml;
              logsContent.scrollTop = logsContent.scrollHeight;
            } else {
              logsContent.innerHTML =
                '<div class="text-muted">No logs available for this container.</div>';
            }
          })
          .catch((error) => {
            logsContent.innerHTML =
              '<div class="text-danger">Error loading logs: ' +
              error.message +
              "</div>";
          });
      }
    </script>

    <footer>
      &copy; {{ 2024 }} Home Server Dashboard. Powered by TrueNAS & Orange Pi.
    </footer>
  </body>
</html>
